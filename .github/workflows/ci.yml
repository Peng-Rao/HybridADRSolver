# GitHub Actions CI Workflow for deal.II Advection-Diffusion-Reaction Solver
#
# This workflow builds and tests the solver using the official deal.II Docker images

name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

env:
  BUILD_TYPE: Release

jobs:
  # =============================================================
  # Build and test using deal.II Docker image
  # =============================================================
  build-docker:
    name: Build (deal.II ${{ matrix.dealii_version }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        # Updated to v9.7.0.
        # Kept v9.6.0 as a secondary check for backward compatibility.
        dealii_version: [ 'v9.7.1-jammy' ]
        include:
          - dealii_version: 'v9.7.1-jammy'
            container: 'dealii/dealii:v9.7.1-jammy'

    container:
      image: ${{ matrix.container }}
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DDEAL_II_DIR=/usr/local

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Run basic solver
        run: |
          cd build
          ./GalerkinSolver

      - name: Verify output files
        run: |
          cd build
          # Check that VTU output files were created
          ls -la solution-*vtu
            if ls solution-*.vtu 1> /dev/null 2>&1; then
                echo "✓ Output VTU files generated"
            else
                echo "✗ No VTU output files found"
                exit 1
            fi

      - name: Upload solution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: solutions-${{ matrix.dealii_version }}
          path: build/solution-*.pvtu
          retention-days: 7

  # =============================================================
  # Code quality checks
  # =============================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run cppcheck
        uses: deep5050/cppcheck-action@v3.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          std: c++17
          enable: warning,style,performance
          force: enable
        continue-on-error: true

  # =============================================================
  # Convergence test
  # =============================================================
  convergence-test:
    name: Convergence Test
    runs-on: ubuntu-latest
    needs: build-docker

    container:
      image: dealii/dealii:v9.7.1-jammy
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build solver
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DDEAL_II_DIR=/usr/local
          make -j$(nproc)

      - name: Run convergence test
        run: |
          cd build
          ./GalerkinSolver > output.log 2>&1
          cat output.log

  # =============================================================
  # Memory check with Valgrind
  # =============================================================
  memory-check:
    name: Memory Check (Valgrind)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'  # Only on PRs to save time

    container:
      image: dealii/dealii:v9.7.1-jammy
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Valgrind
        run: |
          apt-get update
          apt-get install -y valgrind

      - name: Build with debug symbols
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DDEAL_II_DIR=/usr/local
          make -j$(nproc)

      - name: Run Valgrind memcheck
        run: |
          cd build
          valgrind --leak-check=full \
                   --show-leak-kinds=all \
                   --track-origins=yes \
                   --error-exitcode=1 \
                   --suppressions=/usr/local/share/deal.II/valgrind/deal.supp \
                   ./GalerkinSolver 2>&1 | tee valgrind.log || true
          
          # Check for definite memory leaks (ignore possible/reachable)
          if grep -q "definitely lost: [1-9]" valgrind.log; then
            echo "Memory leaks detected!"
            exit 1
          fi
        continue-on-error: true  # Don't fail build on valgrind issues

  # =============================================================
  # Summary job
  # =============================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [ build-docker, convergence-test ]
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.build-docker.result }}" != "success" ]; then
            echo "build-docker failed"
            exit 1
          fi
          if [ "${{ needs.convergence-test.result }}" != "success" ]; then
            echo "convergence-test failed"
            exit 1
          fi
          echo "All required CI checks passed! ✓"